<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kambot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            background: #202123;
            border-right: 1px solid #363739;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 15px;
            overflow-y: auto;
            transition: margin-left 0.3s ease;
            position: fixed; /* Change to fixed positioning */
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3); /* Add shadow for better visibility */
        }
        
        .sidebar.collapsed {
            margin-left: -280px;
        }
        
        .sidebar-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            background: #2a2b2e;
            border: 1px solid #404142;
            border-radius: 8px;
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .sidebar-toggle:hover {
            background: #353639;
            border-color: #565760;
        }
        
        .sidebar-toggle.sidebar-open {
            left: 300px;
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .sidebar-header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #ffffff;
        }
        
        .model-section {
            background: #2a2b2e;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #404142;
        }
        
        .model-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .model-select {
            width: 100%;
            background: #1a1a1a;
            border: 1px solid #404142;
            border-radius: 8px;
            color: #ffffff;
            padding: 10px 12px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .model-select:hover {
            border-color: #10a37f;
            background: #1e1e1e;
        }
        
        .model-select:focus {
            outline: none;
            border-color: #10a37f;
            box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.1);
        }
        
        .model-info {
            font-size: 12px;
            color: #8e8ea0;
            margin-top: 8px;
        }
        
        .sidebar-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .sidebar-button {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #404142;
            border-radius: 8px;
            background: #2a2b2e;
            color: #ffffff;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .sidebar-button:hover {
            background: #353639;
            border-color: #565760;
        }
        
        .sidebar-button:active {
            transform: translateY(1px);
        }
        
        .sidebar-button.danger {
            border-color: #d73a49;
            color: #ff6b6b;
        }
        
        .sidebar-button.danger:hover {
            background: #2d1b1f;
            border-color: #ff6b6b;
        }
        
        .sidebar-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        /* Donation Section */
        .donation-section {
            background: #2a2b2e;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #404142;
            margin-top: auto;
        }
        
        .donation-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .donation-section p {
            font-size: 12px;
            color: #8e8ea0;
            line-height: 1.4;
            margin-bottom: 8px;
        }
        
        .donation-section a {
            color: #10a37f;
            text-decoration: none;
            font-weight: 500;
        }
        
        .donation-section a:hover {
            color: #0d8f6a;
            text-decoration: underline;
        }
        
        /* Custom Modal Styles */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .custom-modal.show {
            display: flex;
        }
        
        .modal-content {
            background: #2a2b2e;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #404142;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal-message {
            font-size: 14px;
            color: #8e8ea0;
            line-height: 1.5;
            margin-bottom: 20px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .modal-button {
            padding: 10px 20px;
            border: 1px solid #404142;
            border-radius: 8px;
            background: #2a2b2e;
            color: #ffffff;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .modal-button:hover {
            background: #353639;
            border-color: #565760;
        }
        
        .modal-button.danger {
            border-color: #d73a49;
            color: #ff6b6b;
        }
        
        .modal-button.danger:hover {
            background: #2d1b1f;
            border-color: #ff6b6b;
        }
        
        /* Main Chat Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #212121;
            height: 100vh;
            transition: margin-left 0.3s ease;
        }
        
        .main-content.sidebar-collapsed {
            margin-left: -100px; /* Reduced from -280px to make it less obstructive */
        }
        
        /* Add overlay effect when sidebar is open */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
            display: none;
            transition: opacity 0.3s ease;
        }
        
        .sidebar-overlay.show {
            display: block;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 50%;
            margin: 0 auto;
            width: 100%;
            padding: 20px;
            gap: 20px;
            padding-top: 80px;
        }
        
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 12px;
            border: 1px solid #404040;
            position: relative;
        }
        
        .message {
            margin-bottom: 20px;
            padding: 16px;
            border-radius: 12px;
            position: relative;
            max-width: 85%;
            word-wrap: break-word;
        }
        
        .user-message {
            background: linear-gradient(135deg, #10a37f, #0d8f6a);
            margin-left: auto;
            color: #ffffff;
            box-shadow: 0 2px 10px rgba(16, 163, 127, 0.3);
        }
        
        .bot-message {
            background: #363636;
            border: 1px solid #505050;
            color: #ffffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .message-role {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            opacity: 0.9;
        }
        
        .message-content {
            line-height: 1.6;
            font-size: 15px;
            white-space: pre-wrap;
        }
        
        .input-area {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #404040;
        }
        
        .input-row {
            display: flex;
            align-items: flex-end;
            gap: 12px;
        }
        
        textarea {
            flex: 1;
            padding: 16px;
            border: 1px solid #404040;
            border-radius: 10px;
            font-size: 16px;
            background: #1a1a1a;
            color: #ffffff;
            resize: none;
            min-height: 56px;
            max-height: 150px;
            line-height: 1.5;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }
        
        textarea:focus {
            outline: none;
            border-color: #10a37f;
            box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.1);
        }
        
        textarea::placeholder {
            color: #8e8ea0;
        }
        
        .send-button {
            padding: 16px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: linear-gradient(135deg, #10a37f, #0d8f6a);
            color: #ffffff;
            box-shadow: 0 2px 10px rgba(16, 163, 127, 0.3);
            min-width: 100px;
        }
        
        .send-button:hover {
            background: linear-gradient(135deg, #0d8f6a, #0a7356);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(16, 163, 127, 0.4);
        }
        
        .send-button:active {
            transform: translateY(0);
        }
        
        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .loading {
            background: #2c8c44;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .spinner {
            display: none;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        .loading .spinner {
            display: inline-block;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        #thinking-indicator {
            display: none;
            margin-top: 15px;
            text-align: center;
            font-style: italic;
            color: #8e8ea0;
            font-size: 14px;
        }
        
        .typing {
            display: inline-block;
            animation: blink 0.7s infinite;
        }
        
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #2a2a2a;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #505050;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #606060;
        }
        
        /* Firefox scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: #505050 #2a2a2a;
        }
        
        /* Welcome message for empty chat */
        .welcome-message {
            text-align: center;
            color: #8e8ea0;
            font-size: 16px;
            margin-top: 50px;
        }
        
        .welcome-message h2 {
            color: #ffffff;
            margin-bottom: 10px;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                padding: 15px;
                border-right: none;
                border-bottom: 1px solid #363739;
                margin-left: 0;
            }
            
            .sidebar.collapsed {
                margin-left: 0;
                margin-top: -300px;
            }
            
            .sidebar-toggle {
                top: 10px;
                left: 10px;
            }
            
            .sidebar-toggle.sidebar-open {
                left: 10px;
                top: 310px;
            }
            
            .sidebar-buttons {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .sidebar-button {
                flex: 1;
                min-width: 120px;
            }
            
            .main-content {
                height: calc(100vh - 300px);
                margin-left: 0;
            }
            
            .main-content.sidebar-collapsed {
                margin-left: 0;
                margin-top: -300px;
                height: 100vh;
            }
            
            .chat-container {
                max-width: 95%;
                padding-top: 60px;
            }
            
            .message {
                max-width: 95%;
            }
            
            .donation-section {
                margin-top: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebar-toggle">‚ò∞</button>
    
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>üòº Kambot</h1>
        </div>
        
        <div class="model-section">
            <h3>ü§ñ Models</h3>
            <select class="model-select" id="model-select">
                {% for model_id, model_info in available_models.items() %}
                    <option value="{{ model_id }}" {% if model_id == current_model %}selected{% endif %}>
                        {{ model_info.name }}
                    </option>
                {% endfor %}
            </select>
            <div class="model-info" id="model-info">
                Choose the AI model that best fits your needs
            </div>
        </div>
        
        <div class="sidebar-buttons">
            <button class="sidebar-button" id="copy-chat-button">
                üìã Copy Chat
            </button>
            <button class="sidebar-button" id="undo-button">
                ‚Ü∂ Undo
            </button>
            <button class="sidebar-button" id="redo-button">
                ‚Ü∑ Redo
            </button>
            <button class="sidebar-button danger" id="clear-button">
                üóëÔ∏è Clear Chat
            </button>
        </div>
        
        <div class="donation-section">
            <h3>üíù Support</h3>
            <p>Note: Chats will not save due to the inpersistent state of the server. Render.com is graciously hosting our web app for free, so it spins down with inactivity. Please use the 'Copy Chat' button to save the chat to your clipboard and paste it somewhere to save for now. This app does not require payment and has no ads. A donation would help and possibly one day our server instance can be upgraded! Here is a secure Stripe link to donate directly to me, which would support and validate my work:</p>
            <p><a href="https://donate.stripe.com/3cs8zU2CPecAfw4eUU" target="_blank">Donate</a></p>
            <p>Thank you,<br>-Kameon</p>
        </div>
    </div>
    
    <!-- Main Chat Area -->
    <div class="main-content" id="main-content">
        <div class="chat-container">
            <div class="chat-history" id="chat-history">
                {% if chat_history %}
                    {% for message in chat_history %}
                        <div class="message {% if message.role == 'user' %}user-message{% else %}bot-message{% endif %}">
                            <div class="message-role">{{ "You" if message.role == 'user' else "Kambot" }}</div>
                            <div class="message-content">{{ message.content }}</div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="welcome-message">
                        <h2>Welcome to Kambot! üòºS</h2>
                        <p>Hey there! I'm Kambot, your AI assistant üò∏. What can I help you with today?</p>
                    </div>
                {% endif %}
                <div id="thinking-indicator">
                    Kambot is thinking<span class="typing">...</span>
                </div>
            </div>
            
            <form method="POST" class="input-area" id="chat-form">
                <div class="input-row">
                    <textarea name="user_query" placeholder="Type your message here... (Press Enter to send)" required autofocus rows="1"></textarea>
                    <button type="submit" class="send-button" id="send-button">
                        <span id="button-text">Send</span>
                        <span class="spinner" id="button-spinner"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Custom Modal for Clear Chat Confirmation -->
    <div class="custom-modal" id="clear-modal">
        <div class="modal-content">
            <div class="modal-title">
                üóëÔ∏è Clear Chat History
            </div>
            <div class="modal-message">
                Are you sure you want to clear the entire chat history? This action cannot be undone.
            </div>
            <div class="modal-buttons">
                <button class="modal-button" id="cancel-clear">Cancel</button>
                <button class="modal-button danger" id="confirm-clear">Clear Chat</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatHistory = document.querySelector('.chat-history');
            const chatForm = document.getElementById('chat-form');
            const textarea = document.querySelector('textarea');
            const button = document.getElementById('send-button');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('button-spinner');
            const thinkingIndicator = document.getElementById('thinking-indicator');
            const clearButton = document.getElementById('clear-button');
            const copyChatButton = document.getElementById('copy-chat-button');
            const undoButton = document.getElementById('undo-button');
            const redoButton = document.getElementById('redo-button');
            const modelSelect = document.getElementById('model-select');
            const modelInfo = document.getElementById('model-info');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const clearModal = document.getElementById('clear-modal');
            const cancelClear = document.getElementById('cancel-clear');
            const confirmClear = document.getElementById('confirm-clear');
            
            // Sidebar toggle functionality - Start with sidebar closed
            let sidebarOpen = false;
            
            // Get overlay element
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            
            // Set initial state properly - sidebar should be collapsed by default
            sidebar.classList.add('collapsed');
            mainContent.classList.add('sidebar-collapsed');
            sidebarToggle.innerHTML = '‚ò∞';
            
            sidebarToggle.addEventListener('click', function() {
                console.log('Toggle clicked, current state:', sidebarOpen); // Debug log
                sidebarOpen = !sidebarOpen;
                
                if (sidebarOpen) {
                    console.log('Opening sidebar'); // Debug log
                    sidebar.classList.remove('collapsed');
                    mainContent.classList.remove('sidebar-collapsed');
                    mainContent.classList.add('sidebar-open');
                    sidebarOverlay.classList.add('show');
                    sidebarToggle.classList.add('sidebar-open');
                    sidebarToggle.innerHTML = '‚úñ';
                } else {
                    console.log('Closing sidebar'); // Debug log
                    sidebar.classList.add('collapsed');
                    mainContent.classList.remove('sidebar-open');
                    mainContent.classList.add('sidebar-collapsed');
                    sidebarOverlay.classList.remove('show');
                    sidebarToggle.classList.remove('sidebar-open');
                    sidebarToggle.innerHTML = '‚ò∞';
                }
            });
            
            // Close sidebar when clicking overlay
            sidebarOverlay.addEventListener('click', function() {
                if (sidebarOpen) {
                    sidebarToggle.click(); // Trigger the toggle to close
                }
            });
            
            // Model selection
            modelSelect.addEventListener('change', function() {
                const selectedModel = this.value;
                fetch('/set_model', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ model_id: selectedModel })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        modelInfo.textContent = `Using ${this.options[this.selectedIndex].text}`;
                    }
                });
            });
            
            // Undo functionality
            undoButton.addEventListener('click', function() {
                fetch('/undo', {
                    method: 'POST',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload(); // Refresh to show updated chat
                    } else {
                        alert(data.error || 'Nothing to undo');
                    }
                });
            });
            
            // Redo functionality - Fixed to properly repost the message
            redoButton.addEventListener('click', function() {
                fetch('/redo', {
                    method: 'POST',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Directly submit the undone message to get a new AI response
                        submitMessage(data.user_message);
                    } else {
                        alert(data.error || 'Nothing to redo');
                    }
                });
            });
            
            // Copy full chat functionality
            copyChatButton.addEventListener('click', function() {
                const messages = document.querySelectorAll('.message');
                let fullChatText = '';
                
                messages.forEach(message => {
                    const role = message.querySelector('.message-role').textContent;
                    const content = message.querySelector('.message-content').textContent;
                    fullChatText += `${role}:\n${content}\n\n`;
                });
                
                copyToClipboard(fullChatText.trim());
            });
            
            // Clear chat modal functionality
            clearButton.addEventListener('click', function() {
                clearModal.classList.add('show');
            });
            
            cancelClear.addEventListener('click', function() {
                clearModal.classList.remove('show');
            });
            
            confirmClear.addEventListener('click', function() {
                clearModal.classList.remove('show');
                fetch('/clear', {
                    method: 'POST',
                }).then(() => {
                    window.location.reload();
                });
            });
            
            // Close modal when clicking outside
            clearModal.addEventListener('click', function(e) {
                if (e.target === clearModal) {
                    clearModal.classList.remove('show');
                }
            });
            
            // Copy text to clipboard
            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(function() {
                    // Temporary feedback
                    const originalText = copyChatButton.textContent;
                    copyChatButton.textContent = '‚úÖ Copied!';
                    setTimeout(() => {
                        copyChatButton.textContent = originalText;
                    }, 2000);
                }).catch(function(err) {
                    console.error('Could not copy text: ', err);
                });
            }
            
            // Auto-scroll to bottom of chat history
            let shouldAutoScroll = true;
            let userHasScrolled = false;
            
            // Listen for user scroll events
            chatHistory.addEventListener('scroll', function() {
                userHasScrolled = true;
                const isAtBottom = chatHistory.scrollHeight - chatHistory.clientHeight <= chatHistory.scrollTop + 20;
                shouldAutoScroll = isAtBottom;
            });
            
            function scrollToBottom() {
                if (shouldAutoScroll && !userHasScrolled) {
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                }
            }
            
            scrollToBottom();
            
            // Auto-resize textarea based on content
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            // Handle Enter key to submit (Shift+Enter for new line)
            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (textarea.value.trim() !== '') {
                        submitForm();
                    }
                }
            });
            
            // Handle form submission
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();
                if (textarea.value.trim() !== '') {
                    submitForm();
                }
            });
            
            // Submit form via AJAX with streaming support
            function submitForm() {
                const userMessage = textarea.value;
                submitMessage(userMessage);
                textarea.value = '';
                textarea.style.height = 'auto';
            }
            
            function submitMessage(userMessage) {
                // When a new message is sent, reset scrolling behavior
                shouldAutoScroll = true;
                userHasScrolled = false;
                
                // Show loading state
                button.disabled = true;
                button.classList.add('loading');
                buttonText.textContent = 'Sending...';
                spinner.style.display = 'inline-block';
                
                // Add user message to chat history
                addMessageToChat('user', userMessage);
                
                // Create a placeholder for the bot response with cursor
                const botMessageDiv = document.createElement('div');
                botMessageDiv.className = 'message bot-message';
                
                const roleDiv = document.createElement('div');
                roleDiv.className = 'message-role';
                roleDiv.textContent = 'Kambot';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.innerHTML = '<span class="typing">|</span>';
                
                botMessageDiv.appendChild(roleDiv);
                botMessageDiv.appendChild(contentDiv);
                
                chatHistory.insertBefore(botMessageDiv, thinkingIndicator);
                thinkingIndicator.style.display = 'none';
                
                scrollToBottom();
                
                // First, send the initial POST request
                fetch('/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: 'user_query=' + encodeURIComponent(userMessage)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.streaming) {
                        return fetch('/stream', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ message_id: data.message_id })
                        }).then(response => {
                            const reader = response.body.getReader();
                            const decoder = new TextDecoder();
                            
                            function processStream() {
                                return reader.read().then(({ done, value }) => {
                                    if (done) {
                                        const finalText = contentDiv.textContent.replace('|', '');
                                        contentDiv.textContent = finalText;
                                        resetButtonState();
                                        return;
                                    }
                                    
                                    const chunk = decoder.decode(value);
                                    const lines = chunk.split('\n\n');
                                    
                                    for (const line of lines) {
                                        if (line.startsWith('data: ')) {
                                            try {
                                                const eventData = JSON.parse(line.substring(6));
                                                
                                                if (eventData.error) {
                                                    contentDiv.textContent = eventData.full;
                                                    resetButtonState();
                                                    return;
                                                }
                                                
                                                const wasAtBottom = !userHasScrolled || 
                                                    (chatHistory.scrollHeight - chatHistory.clientHeight <= chatHistory.scrollTop + 20);
                                                
                                                contentDiv.innerHTML = eventData.full + '<span class="typing">|</span>';
                                                
                                                if (wasAtBottom) {
                                                    chatHistory.scrollTop = chatHistory.scrollHeight;
                                                }
                                            } catch (e) {
                                                console.error('Error parsing SSE data:', e);
                                            }
                                        }
                                    }
                                    
                                    return processStream();
                                });
                            }
                            
                            return processStream();
                        });
                    } else {
                        contentDiv.textContent = data.response;
                        resetButtonState();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    contentDiv.textContent = 'Sorry, an error occurred. Please try again. üòÖ';
                    resetButtonState();
                });
            }
            
            function addMessageToChat(role, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role === 'user' ? 'user-message' : 'bot-message'}`;
                
                const roleDiv = document.createElement('div');
                roleDiv.className = 'message-role';
                roleDiv.textContent = role === 'user' ? 'You' : 'Kambot';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = content;
                
                messageDiv.appendChild(roleDiv);
                messageDiv.appendChild(contentDiv);
                
                chatHistory.insertBefore(messageDiv, thinkingIndicator);
                scrollToBottom();
                
                if (role === 'user') {
                    userHasScrolled = false;
                    shouldAutoScroll = true;
                }
            }
            
            function resetButtonState() {
                button.disabled = false;
                button.classList.remove('loading');
                buttonText.textContent = 'Send';
                spinner.style.display = 'none';
            }
        });
    </script>
</body>
</html>
